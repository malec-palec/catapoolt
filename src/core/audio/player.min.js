const u=new (window.AudioContext||window.webkitAudioContext);
window.Pico8=function(P,Q){const v=P.split("\n"),D=Q.split("\n");let H=0;const g=(a,b,k)=>parseInt(a.substr(b,k),16),R=[a=>Math.abs(2*a-1)-1,a=>.5*(.9>a?2*a/.9-1:2*(1-a)/(1-.9)-1),a=>.6*(.5>a?a:a-1),a=>.5>a?.5:-.5,a=>.3>a?.5:-.5,a=>(.5>a?3-Math.abs(24*a-6):1-Math.abs(16*a-12))/9,()=>{const a=(H+.02*(2*Math.random()-1))/1.02;H=a;return 10*a},(a,b)=>(Math.abs((a+.5*Math.abs(b/128%1*2-1))%1*4-2)-Math.abs(8*a-4))/6],I={},G=(a,b)=>{{const J=a+"-"+b;var k=I[J];if(!k){{a=v[a];k=g(a,2,2);const S=k/120,K=
g(a,4,2),E=g(a,6,2)||32,L=44100*E,M=u.createBuffer(1,L,44100),z=M.getChannelData(0);let w=0,F=0,p=0;var d=24;let N=260;var c=-1;let A=-1;var f=-1;let t,B,r,C,n;for(;w<L;){t=g(a,8+5*p,2)+b;B=65*2**(t/12);r=g(a,5*p+10,1);C=g(a,5*p+11,1)/8;n=g(a,5*p+12,1);var e=p+1>=E?K:p+1,h=g(a,8+5*e,2)+b,q=g(a,5*e+10,1),l=g(a,5*e+11,1),m=g(a,5*e+12,1);e=.02;if(4===n||r===c&&(t===d||1===n)&&0<A&&5!==f)e=0;d=.05;if(5===n||r===q&&(t===h||1===m)&&0<l&&4!==m)d=0;h=44100*S+.5|0;q=7<r&&G(r-8,b+t-24);l=0;for(c=w;c<w+h;c++){f=
(c-w)/h;m=1;f<e?m=f/e:f>1-d&&(m=(1-f)/d);let x=B,y=C;1===n&&(x=(1-f)*N+f*B,0<A&&(y=(1-f)*A+f*C));2===n&&(x*=1+.02*Math.sin(7.5*f));3===n&&(x*=1-f);4===n&&(y*=f);5===n&&(y*=1-f);6<=n&&(x=65*2**((g(a,8+5*(p&-4|((8>=k?32:16)/(6===n?4:8)*f|0)&3),2)+b)/12));F+=x/44100;8>r?z[c]+=y*m*R[r](F%1,F):(z[c]+=y*m*q[l],l=(l+1)%q.length)}w+=h;d=t;N=B;c=r;A=C;f=n;p=p+1>=E?K:p+1}k=M}I[J]=k}return k}},T=(a,b,k,d,c=0)=>{d=G(d,c).getChannelData(0);for(c=0;b<k;)a[b]+=d[c],c=(c+1)%d.length,b++},O=(a,b=!1,k=0)=>{const d=
u.createBufferSource();d.buffer=a;d.loop=b;d.loopStart=k;d.connect(u.destination);d.start();return d};this.sfx=a=>O(G(a,0));this.music=a=>{var b=[];const k=[];let d=0;var c=0;let f=D.length-1;for(var e=a;e<=f;e++){var h=D[e],q=g(h,0,2);b[e]=0;for(var l=0;4>l;l++){var m=g(h,3+2*l,2);if(m<v.length&&0===g(v[m],6,2)){b[e]=l;break}}h=g(h,3+2*b[e],2);h=g(v[h],2,2)/120;k[e]=1411200*h+.5|0;1===(q&1)&&(d=c);c+=32*h;if(2===(q&2)){f=e;break}}b=u.createBuffer(1,44100*c,44100);c=b.getChannelData(0);for(e=0;a<=
f;a++){q=D[a];h=k[a];for(l=0;4>l;l++)m=g(q,3+2*l,2),m<v.length&&T(c,e,e+h,m);e+=h}return O(b,!0,d)};this.audioCtx=u};
